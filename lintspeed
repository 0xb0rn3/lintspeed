#!/bin/bash
#
# LINTSPEED v2.0 - Lightning-Fast Network Testing
# Pure C + Bash Implementation
# by 0xb0rn3 | 0xbv1
#
# MIT License - Copyright (c) 2025
#

set -e

VERSION="2.0.0"
BINARY_NAME="lintspeed-core"
SOURCE_NAME="lintspeed.c"
INSTALL_DIR="$HOME/.lintspeed"
BINARY_PATH="$INSTALL_DIR/$BINARY_NAME"
CONFIG_FILE="$INSTALL_DIR/config"
HISTORY_FILE="$INSTALL_DIR/history.csv"
SYSTEM_INSTALL="/usr/local/bin/lintspeed"

# Color codes
RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
CYAN='\033[1;36m'
RESET='\033[0m'
BOLD='\033[1m'

print_banner() {
    clear
    echo -e "${CYAN}"
    cat << "EOF"
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                                                                      ‚ïë
‚ïë    ‚ñà‚ñà‚ïó     ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ïë
‚ïë    ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë‚ïë
‚ïë    ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ïë
‚ïë    ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïù ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë‚ïë
‚ïë    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ïë
‚ïë    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù   ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù‚ïë
‚ïë                                                                      ‚ïë
‚ïë              v2.0 - Pure C Edition ‚Ä¢ 10x Faster ‚Ä¢ 100% Linux        ‚ïë
‚ïë                                                                      ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
EOF
    echo -e "${RESET}"
}

log_info() {
    echo -e "${GREEN}[‚úì]${RESET} $1"
}

log_warn() {
    echo -e "${YELLOW}[!]${RESET} $1"
}

log_error() {
    echo -e "${RED}[‚úó]${RESET} $1"
}

log_step() {
    echo -e "${BLUE}[*]${RESET} $1"
}

check_dependencies() {
    local missing=()
    
    if ! command -v gcc &> /dev/null; then
        missing+=("gcc")
    fi
    
    if ! command -v make &> /dev/null; then
        missing+=("make")
    fi
    
    if ! ldconfig -p 2>/dev/null | grep -q libncurses; then
        missing+=("ncurses-dev")
    fi
    
    if [ ${#missing[@]} -gt 0 ]; then
        return 1
    fi
    
    return 0
}

install_dependencies() {
    log_step "Installing build dependencies..."
    
    if command -v apt-get &> /dev/null; then
        sudo apt-get update -qq
        sudo apt-get install -y gcc make libncurses5-dev
    elif command -v dnf &> /dev/null; then
        sudo dnf install -y gcc make ncurses-devel
    elif command -v yum &> /dev/null; then
        sudo yum install -y gcc make ncurses-devel
    elif command -v pacman &> /dev/null; then
        sudo pacman -S --noconfirm gcc make ncurses
    elif command -v zypper &> /dev/null; then
        sudo zypper install -y gcc make ncurses-devel
    elif command -v apk &> /dev/null; then
        sudo apk add gcc make ncurses-dev musl-dev linux-headers
    else
        log_error "Unknown package manager. Please install: gcc, make, ncurses-dev"
        exit 1
    fi
}

extract_source() {
    log_step "Extracting C source code..."
    
    mkdir -p "$INSTALL_DIR"
    
    # Extract embedded C source (will be added after this script)
    sed -n '/^__CSOURCE_START__$/,/^__CSOURCE_END__$/p' "$0" | \
        sed '1d;$d' > "$INSTALL_DIR/$SOURCE_NAME"
    
    if [ ! -s "$INSTALL_DIR/$SOURCE_NAME" ]; then
        log_error "Failed to extract source code"
        exit 1
    fi
}

compile_binary() {
    log_step "Compiling optimized binary..."
    
    cd "$INSTALL_DIR"
    
    # Compile with maximum optimization
    gcc -O3 -march=native -flto -pthread \
        -Wall -Wextra -pedantic \
        -o "$BINARY_NAME" "$SOURCE_NAME" \
        -lncurses -lpthread -lm -lrt \
        2>&1 | grep -v "warning:" || true
    
    if [ ! -f "$BINARY_NAME" ]; then
        log_error "Compilation failed"
        exit 1
    fi
    
    chmod +x "$BINARY_NAME"
    
    log_info "Binary compiled: $(du -h "$BINARY_NAME" | cut -f1)"
}

setup_first_run() {
    print_banner
    
    log_step "First-time setup for lintspeed v$VERSION"
    echo ""
    
    if ! check_dependencies; then
        log_warn "Missing dependencies detected"
        echo ""
        read -p "Install build tools automatically? (y/n): " -r
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            install_dependencies
        else
            log_error "Cannot proceed without dependencies"
            exit 1
        fi
    fi
    
    extract_source
    compile_binary
    
    # Create config
    cat > "$CONFIG_FILE" << EOF
# lintspeed v2.0 configuration
VERSION=$VERSION
FIRST_RUN_DATE=$(date +%Y-%m-%d)
DEFAULT_SERVER=1.1.1.1
HISTORY_ENABLED=1
EOF
    
    # Initialize history
    echo "timestamp,download_mbps,upload_mbps,ping_ms,jitter_ms,packet_loss_pct" > "$HISTORY_FILE"
    
    echo ""
    log_info "Setup complete!"
    echo ""
    read -p "Install system-wide to /usr/local/bin? (y/n): " -r
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        if [ "$EUID" -ne 0 ]; then
            sudo cp "$0" "$SYSTEM_INSTALL"
            sudo chmod +x "$SYSTEM_INSTALL"
        else
            cp "$0" "$SYSTEM_INSTALL"
            chmod +x "$SYSTEM_INSTALL"
        fi
        log_info "Installed to $SYSTEM_INSTALL"
        log_info "Run 'lintspeed' from anywhere!"
    fi
    
    echo ""
    log_step "Starting lintspeed..."
    sleep 2
}

check_root_capabilities() {
    # Check if we can use raw sockets (for ICMP)
    if [ "$EUID" -eq 0 ]; then
        return 0
    fi
    
    # Check CAP_NET_RAW capability
    if command -v getcap &> /dev/null; then
        if getcap "$BINARY_PATH" 2>/dev/null | grep -q cap_net_raw; then
            return 0
        fi
    fi
    
    return 1
}

grant_capabilities() {
    log_warn "ICMP ping requires raw socket capability"
    echo ""
    echo "Options:"
    echo "  1) Grant CAP_NET_RAW to binary (recommended, persistent)"
    echo "  2) Run with sudo this time only"
    echo "  3) Use TCP ping fallback (no root required)"
    echo ""
    read -p "Choose (1/2/3): " -r choice
    
    case $choice in
        1)
            sudo setcap cap_net_raw+ep "$BINARY_PATH"
            log_info "Capability granted permanently"
            ;;
        2)
            log_info "Running with sudo..."
            sudo "$BINARY_PATH" "$@"
            exit 0
            ;;
        3)
            log_info "Using TCP ping mode"
            export LINTSPEED_NO_ICMP=1
            ;;
        *)
            log_warn "Invalid choice, using TCP fallback"
            export LINTSPEED_NO_ICMP=1
            ;;
    esac
}

show_help() {
    cat << EOF
${BOLD}lintspeed v$VERSION${RESET} - Lightning-Fast Network Performance Testing

${BOLD}USAGE:${RESET}
    lintspeed [OPTIONS]

${BOLD}OPTIONS:${RESET}
    -h, --help              Show this help message
    -v, --version           Show version information
    -s, --server <IP>       Set custom test server (default: 1.1.1.1)
    -6, --ipv6              Use IPv6 instead of IPv4
    -i, --interface <dev>   Bind to specific network interface
    -e, --export <file>     Export results to JSON/CSV file
    -q, --quick             Quick test (fewer samples)
    -n, --no-history        Don't save results to history
    --rebuild               Force rebuild of binary
    --reset                 Reset configuration to defaults

${BOLD}EXAMPLES:${RESET}
    lintspeed                           # Run interactive test
    lintspeed -s 8.8.8.8               # Test against Google DNS
    lintspeed -e results.json          # Export results to JSON
    lintspeed -6 -s 2606:4700:4700::1111  # IPv6 test to Cloudflare

${BOLD}FEATURES:${RESET}
    ‚ö° True ICMP ping (with TCP fallback)
    üìä Real-time bandwidth graphs
    üéØ Jitter and packet loss analysis
    üîç MTU detection and path analysis
    üìà Historical data tracking
    üåê IPv4 and IPv6 support
    üíæ Export to JSON/CSV formats
    üöÄ 10x faster than Python version

${BOLD}CONTROLS (Interactive Mode):${RESET}
    ENTER       Start test
    R           Reset statistics
    S           Change server
    H           View history
    E           Export current results
    Q           Quit

${BOLD}FILES:${RESET}
    Config:     $CONFIG_FILE
    History:    $HISTORY_FILE
    Binary:     $BINARY_PATH

${BOLD}REQUIREMENTS:${RESET}
    ‚Ä¢ Linux kernel 2.6+
    ‚Ä¢ gcc, make, ncurses (auto-installed)
    ‚Ä¢ CAP_NET_RAW for ICMP (optional)

For more information: https://github.com/0xb0rn3/lintspeed
EOF
}

# Parse command line arguments
parse_args() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                show_help
                exit 0
                ;;
            -v|--version)
                echo "lintspeed v$VERSION"
                exit 0
                ;;
            --rebuild)
                log_step "Forcing rebuild..."
                extract_source
                compile_binary
                log_info "Rebuild complete"
                exit 0
                ;;
            --reset)
                log_step "Resetting configuration..."
                rm -rf "$INSTALL_DIR"
                log_info "Reset complete. Run again to reinitialize."
                exit 0
                ;;
            *)
                # Pass through to C binary
                EXTRA_ARGS="$EXTRA_ARGS $1"
                ;;
        esac
        shift
    done
}

# Main execution
main() {
    parse_args "$@"
    
    # First run setup
    if [ ! -f "$BINARY_PATH" ]; then
        setup_first_run
    fi
    
    # Check for updates (compare versions)
    if [ -f "$CONFIG_FILE" ]; then
        source "$CONFIG_FILE"
        if [ "$VERSION" != "$VERSION" ]; then
            log_warn "Version mismatch detected, rebuilding..."
            extract_source
            compile_binary
        fi
    fi
    
    # Check capabilities for ICMP
    if ! check_root_capabilities; then
        if [ -z "$LINTSPEED_NO_ICMP" ]; then
            # Silent fallback to TCP - no prompts during execution
            export LINTSPEED_NO_ICMP=1
        fi
    fi
    
    # Launch the C binary
    exec "$BINARY_PATH" $EXTRA_ARGS
}

# Run main function
main "$@"

# Embedded C source code follows
exit 0

__CSOURCE_START__
