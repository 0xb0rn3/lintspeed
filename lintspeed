#!/bin/bash

INSTALL_FLAG="$HOME/.lintspeed_installed"
SCRIPT_PATH="/usr/local/bin/lintspeed"

if [ ! -f "$INSTALL_FLAG" ]; then
    clear
    echo "════════════════════════════════════════════════════════════"
    echo "  LINTSPEED v1.0 - First Time Setup"
    echo "  by 0xbv1 | 0xb0rn3"
    echo "════════════════════════════════════════════════════════════"
    echo ""
    
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        echo "[*] Detected: $PRETTY_NAME"
    else
        echo "[*] Linux distribution detected"
    fi
    
    echo "[*] Installing required dependencies..."
    
    if command -v apt-get &> /dev/null; then
        sudo apt-get update -qq > /dev/null 2>&1
        sudo apt-get install -y python3 python3-pip > /dev/null 2>&1
    elif command -v dnf &> /dev/null; then
        sudo dnf install -y python3 python3-pip > /dev/null 2>&1
    elif command -v yum &> /dev/null; then
        sudo yum install -y python3 python3-pip > /dev/null 2>&1
    elif command -v pacman &> /dev/null; then
        sudo pacman -Sy --noconfirm python python-pip > /dev/null 2>&1
    elif command -v zypper &> /dev/null; then
        sudo zypper install -y python3 python3-pip > /dev/null 2>&1
    elif command -v apk &> /dev/null; then
        sudo apk add --no-cache python3 py3-pip > /dev/null 2>&1
    fi
    
    echo "[*] Installing Python packages..."
    pip3 install --break-system-packages requests > /dev/null 2>&1 || pip3 install requests > /dev/null 2>&1
    
    touch "$INSTALL_FLAG"
    
    echo ""
    echo "[?] Install lintspeed system-wide? (y/n)"
    read -r response
    if [[ "$response" =~ ^[Yy]$ ]]; then
        if [ "$EUID" -ne 0 ]; then
            echo "[*] Requesting sudo privileges for system-wide installation..."
            sudo cp "$0" "$SCRIPT_PATH"
            sudo chmod +x "$SCRIPT_PATH"
            echo "[✓] Installed to $SCRIPT_PATH"
            echo "[✓] You can now run 'lintspeed' from anywhere"
        else
            cp "$0" "$SCRIPT_PATH"
            chmod +x "$SCRIPT_PATH"
            echo "[✓] Installed to $SCRIPT_PATH"
        fi
    else
        echo "[*] Skipping system-wide installation"
        echo "[*] Run this script directly: ./$0"
    fi
    
    echo ""
    echo "[✓] Setup complete! Starting lintspeed..."
    sleep 2
fi

python3 - <<'PYTHON_CODE'
#!/usr/bin/env python3

import socket
import time
import threading
import requests
import statistics
from datetime import datetime
import sys
import os

class NetworkTester:
    def __init__(self):
        self.download_speed = 0
        self.upload_speed = 0
        self.ping = 0
        self.jitter = 0
        self.packet_loss = 0
        self.server = "1.1.1.1"
        self.testing = False
        self.progress = 0
        self.status = "Ready"
        
    def measure_ping(self, host, count=20):
        pings = []
        lost = 0
        
        for i in range(count):
            try:
                sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                sock.settimeout(2)
                start = time.time()
                sock.connect((host, 80))
                end = time.time()
                sock.close()
                pings.append((end - start) * 1000)
            except:
                lost += 1
            self.progress = (i + 1) / count * 25
            self.status = f"Testing ping... {i+1}/{count}"
        
        if pings:
            self.ping = statistics.mean(pings)
            self.jitter = statistics.stdev(pings) if len(pings) > 1 else 0
        self.packet_loss = (lost / count) * 100
        
    def measure_download(self):
        test_urls = [
            "http://speedtest.ftp.otenet.gr/files/test100k.db",
            "http://speedtest.ftp.otenet.gr/files/test1Mb.db",
            "http://speedtest.ftp.otenet.gr/files/test10Mb.db"
        ]
        
        speeds = []
        for idx, url in enumerate(test_urls):
            try:
                self.status = f"Testing download... {idx+1}/3"
                start = time.time()
                response = requests.get(url, timeout=15, stream=True)
                total_size = 0
                for chunk in response.iter_content(chunk_size=8192):
                    total_size += len(chunk)
                end = time.time()
                
                duration = end - start
                speed_mbps = (total_size * 8) / (duration * 1000000)
                speeds.append(speed_mbps)
                self.progress = 25 + ((idx + 1) / len(test_urls)) * 37.5
            except:
                pass
        
        if speeds:
            self.download_speed = max(speeds)
    
    def measure_upload(self):
        upload_url = "http://httpbin.org/post"
        data_sizes = [1024 * 100, 1024 * 500, 1024 * 1000]
        speeds = []
        
        for idx, size in enumerate(data_sizes):
            try:
                self.status = f"Testing upload... {idx+1}/3"
                data = b'x' * size
                start = time.time()
                response = requests.post(upload_url, data=data, timeout=15)
                end = time.time()
                
                duration = end - start
                speed_mbps = (size * 8) / (duration * 1000000)
                speeds.append(speed_mbps)
                self.progress = 62.5 + ((idx + 1) / len(data_sizes)) * 37.5
            except:
                pass
        
        if speeds:
            self.upload_speed = max(speeds)
    
    def run_test(self):
        self.testing = True
        self.progress = 0
        self.status = "Starting test..."
        self.measure_ping(self.server)
        self.measure_download()
        self.measure_upload()
        self.progress = 100
        self.status = "Test complete"
        self.testing = False

def clear_screen():
    os.system('clear')

def print_centered(text, width=80):
    print(text.center(width))

def print_bar(char="═", width=80):
    print(char * width)

def print_progress_bar(progress, width=50):
    filled = int(width * progress / 100)
    bar = "█" * filled + "░" * (width - filled)
    return f"[{bar}] {progress:.0f}%"

def format_metric(label, value, width=35):
    return f"  {label}:".ljust(20) + f"{value}".ljust(15)

def display_ui(tester):
    while True:
        clear_screen()
        
        print_bar("═", 80)
        print_centered("LINTSPEED v1.0", 80)
        print_centered("by 0xbv1 | 0xb0rn3", 80)
        print_bar("═", 80)
        print()
        
        print_bar("─", 80)
        print_centered("NETWORK STATISTICS", 80)
        print_bar("─", 80)
        print()
        
        print(format_metric("Download Speed", f"{tester.download_speed:.2f} Mbps"))
        print(format_metric("Upload Speed", f"{tester.upload_speed:.2f} Mbps"))
        print(format_metric("Ping", f"{tester.ping:.2f} ms"))
        print(format_metric("Jitter", f"{tester.jitter:.2f} ms"))
        
        loss_indicator = "⚠" if tester.packet_loss > 5 else "✓"
        print(format_metric("Packet Loss", f"{tester.packet_loss:.1f}% {loss_indicator}"))
        print()
        
        if tester.testing:
            print_bar("─", 80)
            print_centered("TEST PROGRESS", 80)
            print_bar("─", 80)
            print()
            print(f"  {print_progress_bar(tester.progress, 60)}")
            print(f"  Status: {tester.status}")
            print()
        
        print_bar("─", 80)
        print_centered("CONTROLS", 80)
        print_bar("─", 80)
        print()
        print_centered("[ENTER] Run Test  |  [R] Reset  |  [Q] Quit", 80)
        print()
        print_bar("═", 80)
        
        server_info = f"Server: {tester.server}"
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        spacing = " " * (80 - len(server_info) - len(timestamp))
        print(f"{server_info}{spacing}{timestamp}")
        
        if not tester.testing:
            break
        
        time.sleep(0.2)

def main():
    tester = NetworkTester()
    
    import termios
    import tty
    
    def get_key():
        fd = sys.stdin.fileno()
        old_settings = termios.tcgetattr(fd)
        try:
            tty.setraw(fd)
            ch = sys.stdin.read(1)
        finally:
            termios.tcsetattr(fd, termios.TCSADRAIN, old_settings)
        return ch
    
    display_ui(tester)
    
    while True:
        print("\n\033[1;33m>\033[0m ", end="", flush=True)
        
        key = get_key()
        
        if key.lower() == 'q':
            clear_screen()
            print("\n\033[1;32m[✓]\033[0m Thank you for using lintspeed!")
            print()
            break
        elif key == '\r' or key == '\n':
            if not tester.testing:
                test_thread = threading.Thread(target=tester.run_test)
                test_thread.daemon = True
                test_thread.start()
                
                while tester.testing:
                    display_ui(tester)
                    time.sleep(0.2)
                
                display_ui(tester)
        elif key.lower() == 'r':
            tester.download_speed = 0
            tester.upload_speed = 0
            tester.ping = 0
            tester.jitter = 0
            tester.packet_loss = 0
            tester.progress = 0
            tester.status = "Ready"
            display_ui(tester)

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        clear_screen()
        print("\n\033[1;32m[✓]\033[0m Exiting lintspeed...")
        print()
PYTHON_CODE
